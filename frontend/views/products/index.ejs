<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/dashboard.css" rel="stylesheet">
</head>
<body>
    <%- include('../partials/header') %>
    
    <div class="container-fluid">
        <div class="row">
            <%- include('../partials/sidebar') %>
            
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-boxes me-2"></i>Produtos
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-filter me-1"></i>Filtrar
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-download me-1"></i>Exportar
                            </button>
                        </div>
                        <a href="/products/add" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus me-1"></i>Adicionar Produto
                        </a>
                    </div>
                </div>
                
                <%- include('../partials/alerts') %>
                
                <!-- Filtros -->
                <div class="card mb-4">
                    <div class="card-body">
                        <form class="row g-3">
                            <div class="col-md-3">
                                <label for="searchName" class="form-label">Nome do Produto</label>
                                <input type="text" class="form-control" id="searchName" placeholder="Buscar por nome...">
                            </div>
                            <div class="col-md-3">
                                <label for="filterCategory" class="form-label">Categoria</label>
                                <select class="form-select" id="filterCategory">
                                    <option value="">Todas as categorias</option>
                                    <option value="alimentos">Alimentos</option>
                                    <option value="medicamentos">Medicamentos</option>
                                    <option value="cosmeticos">Cosméticos</option>
                                    <option value="limpeza">Limpeza</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterStatus" class="form-label">Status</label>
                                <select class="form-select" id="filterStatus">
                                    <option value="">Todos os status</option>
                                    <option value="valid">Válidos</option>
                                    <option value="near_expiry">Próximos ao vencimento</option>
                                    <option value="expired">Vencidos</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" class="btn btn-primary me-2">
                                    <i class="fas fa-search me-1"></i>Buscar
                                </button>
                                <button type="button" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>Limpar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Tabela de produtos -->
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-list me-2"></i>Lista de Produtos
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="productsTable" width="100%" cellspacing="0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Código</th>
                                        <th>Nome</th>
                                        <th>Categoria</th>
                                        <th>Data de Vencimento</th>
                                        <th>Quantidade</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (products && products.length > 0) { %>
                                        <% products.forEach(product => { %>
                                            <tr>
                                                <td><%= product.code || product.id %></td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <% if (product.image) { %>
                                                            <img src="<%= product.image %>" alt="<%= product.name %>" 
                                                                 class="rounded me-2" width="40" height="40">
                                                        <% } else { %>
                                                            <div class="bg-light rounded me-2 d-flex align-items-center justify-content-center" 
                                                                 style="width: 40px; height: 40px;">
                                                                <i class="fas fa-box text-muted"></i>
                                                            </div>
                                                        <% } %>
                                                        <div>
                                                            <div class="fw-bold"><%= product.name %></div>
                                                            <% if (product.brand) { %>
                                                                <small class="text-muted"><%= product.brand %></small>
                                                            <% } %>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-secondary"><%= product.category %></span>
                                                </td>
                                                <td>
                                                    <%= new Date(product.expiryDate).toLocaleDateString('pt-BR') %>
                                                </td>
                                                <td><%= product.quantity %></td>
                                                <td>R$ <%= (product.value || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %></td>
                                                <td>
                                                    <% 
                                                        const today = new Date();
                                                        const expiryDate = new Date(product.expiryDate);
                                                        const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                                                        let statusClass = 'success';
                                                        let statusText = 'Válido';
                                                        
                                                        if (daysUntilExpiry < 0) {
                                                            statusClass = 'danger';
                                                            statusText = 'Vencido';
                                                        } else if (daysUntilExpiry <= 30) {
                                                            statusClass = 'warning';
                                                            statusText = 'Próximo ao vencimento';
                                                        }
                                                    %>
                                                    <span class="badge bg-<%= statusClass %>"><%= statusText %></span>
                                                    <% if (daysUntilExpiry >= 0 && daysUntilExpiry <= 30) { %>
                                                        <br><small class="text-muted"><%= daysUntilExpiry %> dias</small>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <a href="/products/<%= product.id %>" class="btn btn-sm btn-outline-primary" 
                                                           title="Visualizar">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <a href="/products/<%= product.id %>/edit" class="btn btn-sm btn-outline-warning" 
                                                           title="Editar">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                                onclick="deleteProduct('<%= product.id %>')" title="Excluir">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                <i class="fas fa-box fa-3x mb-3 d-block"></i>
                                                <h5>Nenhum produto encontrado</h5>
                                                <p>Comece adicionando seu primeiro produto.</p>
                                                <a href="/products/add" class="btn btn-primary">
                                                    <i class="fas fa-plus me-1"></i>Adicionar Produto
                                                </a>
                                            </td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Paginação -->
                        <% if (products && products.length > 0) { %>
                            <nav aria-label="Navegação de páginas">
                                <ul class="pagination justify-content-center mt-3">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Anterior</a>
                                    </li>
                                    <li class="page-item active">
                                        <a class="page-link" href="#">1</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">2</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">3</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">Próximo</a>
                                    </li>
                                </ul>
                            </nav>
                        <% } %>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <%- include('../partials/footer') %>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function deleteProduct(productId) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                // Implementar exclusão via AJAX
                fetch(`/products/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Erro ao excluir produto');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao excluir produto');
                });
            }
        }
        
        // Filtros em tempo real
        document.getElementById('searchName').addEventListener('input', filterProducts);
        document.getElementById('filterCategory').addEventListener('change', filterProducts);
        document.getElementById('filterStatus').addEventListener('change', filterProducts);
        
        function filterProducts() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const filterCategory = document.getElementById('filterCategory').value;
            const filterStatus = document.getElementById('filterStatus').value;
            
            const rows = document.querySelectorAll('#productsTable tbody tr');
            
            rows.forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const category = row.cells[2].textContent.toLowerCase();
                const status = row.cells[6].textContent.toLowerCase();
                
                let showRow = true;
                
                if (searchName && !name.includes(searchName)) {
                    showRow = false;
                }
                
                if (filterCategory && !category.includes(filterCategory)) {
                    showRow = false;
                }
                
                if (filterStatus) {
                    if (filterStatus === 'valid' && !status.includes('válido')) {
                        showRow = false;
                    } else if (filterStatus === 'near_expiry' && !status.includes('próximo')) {
                        showRow = false;
                    } else if (filterStatus === 'expired' && !status.includes('vencido')) {
                        showRow = false;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }
    </script>
</body>
</html>